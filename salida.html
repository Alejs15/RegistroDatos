<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Interfaz OUT – Registro de Llamadas</title>
    <style>
        :root {
            --bg: #f7f9fc;
            --card: #ffffff;
            --ink: #1f2937;
            --muted: #6b7280;
            --primary: #2563eb;
            --border: #e5e7eb;
            --ok: #16a34a;
            --warn: #eab308;
            --ro-bkg: #eef2ff;
            --ro-ink: #1e3a8a;
            --ro-bd: #c7d2fe;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif
        }

        header {
            max-width: 1100px;
            margin: 28px auto 0;
            padding: 0 18px 8px
        }

        h1 {
            font-size: 28px;
            margin: 0 0 6px
        }

        .card {
            max-width: 1100px;
            margin: 14px auto 22px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 22px 20px;
            box-shadow: 0 6px 20px rgba(31, 41, 55, .06)
        }

        form {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(2, minmax(0, 1fr))
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        label {
            font-size: 20px;
            font-weight: 600
        }

        input,
        select,
        textarea {
            font-size: 18px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #fff;
            outline: none;
            transition: border-color .15s, box-shadow .15s
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, .12)
        }

        .full {
            grid-column: 1/-1
        }

        .readonly {
            background: #f3f4f6
        }

        .readonly-strong {
            background: var(--ro-bkg) !important;
            color: var(--ro-ink) !important;
            border-color: var(--ro-bd) !important;
            font-weight: 700
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap
        }

        .btn {
            font-size: 16px;
            font-weight: 600;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid transparent;
            background: var(--primary);
            color: #fff;
            cursor: pointer
        }

        .btn.primary,
        .btn.secondary {
            background: #fff;
            color: var(--ink);
            border-color: var(--border)
        }

        .btn.ghost {
            background: transparent;
            color: var(--primary);
            border-color: transparent
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--border);
            background: #fff
        }

        .pill.ok {
            border-color: #bbf7d0;
            background: #ecfdf5;
            color: var(--ok)
        }

        .pill.warn {
            border-color: #fef08a;
            background: #fffbeb;
            color: #854d0e
        }

        .attempts {
            border-top: 1px dashed var(--border);
            padding-top: 14px;
            margin-top: 8px
        }

        .attempts table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px
        }

        .attempts th,
        .attempts td {
            border-bottom: 1px solid var(--border);
            padding: 8px 6px;
            text-align: left
        }

        .foot {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 12px
        }

        @media (max-width:900px) {
            form {
                grid-template-columns: 1fr
            }
        }

        /* Modal */
        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .35);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 50
        }

        .backdrop.show {
            display: flex
        }

        .modal {
            width: min(920px, 100%);
            background: #fff;
            border-radius: 14px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, .2);
            padding: 14px
        }

        .modal-hd {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 6px 12px
        }

        .modal table {
            width: 100%;
            border-collapse: collapse
        }

        .modal th,
        .modal td {
            border-bottom: 1px solid var(--border);
            padding: 8px
        }

        .modal input,
        .modal select {
            width: 100%
        }

        .muted {
            color: var(--muted)
        }

        .tabla-gestiones th,
        .tabla-gestiones td {
            text-align: center;
            vertical-align: middle
        }

        .tabla-gestiones td:nth-child(1),
        .tabla-gestiones td:nth-child(2),
        .tabla-gestiones td:nth-child(3) {
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace
        }
    </style>
</head>

<body>
    <header>
        <h1>Registro de datos para llamadas salientes</h1>
    </header>

    <section class="card">
        <div class="row" style="justify-content:space-between; margin-bottom:8px">
            <div class="pill" id="statusPill"><strong>Estado:</strong> Listo</div>
            <div class="row">
                <button class="btn secondary" type="button" id="btnIntentos">Ver intentos (24 h)</button>
                <button class="btn ghost" type="button" id="btnLimpiar">Limpiar</button>
            </div>
        </div>

        <form id="frm">
            <div class="field">
                <label for="idllamada">ID LLAMADA</label>
                <input id="idllamada" name="idllamada" maxlength="50" placeholder="ID de Genesys (URL)" class="readonly"
                       readonly />
            </div>

            <div class="field">
                <label for="iduser">ID USER</label>
                <input id="iduser" name="iduser" maxlength="50" placeholder="ID del asesor (Genesys URL)"
                       class="readonly" readonly />
            </div>

            <div class="field">
                <label for="numero_in">CELULAR CLIENTE</label>
                <input id="numero_in" name="numero_in" maxlength="20" inputmode="tel" placeholder="Ej. 999888777" />
            </div>

            <div class="field">
                <label for="dni">DNI</label>
                <div class="row">
                    <input id="dni" name="dni" maxlength="15" placeholder="Documento del cliente" style="flex:1" />
                    <button class="btn secondary" type="button" id="btnBuscarDni">Buscar cliente</button>
                </div>
            </div>

            <div class="field">
                <label for="grupo_cola">GRUPO COLA</label>
                <input id="grupo_cola" name="grupo_cola" maxlength="50" placeholder="Cola ACD (Genesys)" />
            </div>

            <div class="field">
                <label for="fecha_in">INICIO DE LLAMADA</label>
                <input id="fecha_in" name="fecha_in" type="datetime-local" />
            </div>

            <div class="field">
                <label for="nombre_cliente">NOMBRE CLIENTE</label>
                <input id="nombre_cliente" name="nombre_cliente" maxlength="50" placeholder="Nombre del cliente" />
            </div>

            <div class="field">
                <label for="telefono2">TELEFONO 2</label>
                <input id="telefono2" name="telefono2" maxlength="20" inputmode="tel" placeholder="Teléfono alterno" />
            </div>

            <div class="field">
                <label for="correo">CORREO</label>
                <input id="correo" name="correo" maxlength="50" type="email" placeholder="correo@dominio.com" />
            </div>

            <div class="field">
                <label for="fecha_nacimiento">FECHA NACIMIENTO</label>
                <input id="fecha_nacimiento" name="fecha_nacimiento" type="date" />
            </div>

            <div class="field full">
                <label for="direccion">DIRECCION</label>
                <input id="direccion" name="direccion" maxlength="300" placeholder="Dirección completa" />
            </div>

            <div class="field full">
                <label for="observaciones">OBSERVACIONES</label>
                <textarea id="observaciones" name="observaciones" maxlength="1000" rows="4"
                          placeholder="Notas del agente"></textarea>
            </div>

            <div class="field">
                <label for="intento_alerta">INTENTO ALERTA</label>
                <select id="intento_alerta" name="intento_alerta">
                    <option value="">Seleccione…</option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                </select>
            </div>

            <div class="field">
                <label>DATOS DE ALERTA</label>
                <div class="row" style="width:100%">
                    <button class="btn primary" type="button" id="btnGestion">Datos de gestión</button>
                    <button class="btn secondary" type="button" id="btnCuentas">Detalles de cuentas</button>
                </div>
                <span class="hint">Resumen cuentas: <span id="resumenCuentas" class="muted">—</span></span>
            </div>

            <div class="field">
                <label for="accion_llamada">ACCIÓN LLAMADA</label>
                <select id="accion_llamada" name="accion_llamada">
                    <option value="">Seleccione acción…</option>
                </select>
            </div>

            <div class="field">
                <label for="sub_accion_llamada">SUB ACCIÓN LLAMADA</label>
                <select id="sub_accion_llamada" name="sub_accion_llamada">
                    <option value="">Seleccione sub acción…</option>
                </select>
            </div>

            <div class="field">
                <label for="estado_llamada_main">ESTADO LLAMADA</label>
                <select id="estado_llamada_main" name="estado_llamada_main">
                    <option value="">Seleccione…</option>
                    <option value="concluido">Concluido</option>
                    <option value="no_concluido">No concluido</option>
                </select>
            </div>

            <div class="field">
                <label for="detalle_validacion">DETALLE / TIPO VALIDACIÓN</label>
                <select id="detalle_validacion" name="detalle_validacion">
                    <option value="">Seleccione detalle / tipo validación…</option>
                </select>
            </div>

            <div class="field">
                <label>TIPIFICACIÓN</label>
                <div class="row">
                    <label class="pill"><input type="radio" name="tipificacion" value="1"> &nbsp;1</label>
                    <label class="pill"><input type="radio" name="tipificacion" value="2"> &nbsp;2</label>
                </div>
            </div>

            <input type="hidden" id="fecha_fin" name="fecha_fin" />

            <div class="full foot">
                <button class="btn" type="submit">Guardar</button>
            </div>

            <div class="full attempts" id="attemptsPanel" hidden>
                <div class="row" style="justify-content:space-between; margin-bottom:10px">
                    <strong>Intentos en las últimas 24 horas:</strong>
                    <span id="attemptsBadge" class="pill">0 intentos</span>
                </div>
                <div id="attemptsWarn" class="pill warn" style="margin-bottom:10px" hidden>
                    Se encontraron intentos
                    previos.
                </div>
                <table id="attemptsTable">
                    <thead>
                        <tr>
                            <th>Fecha/Hora</th>
                            <th>ID</th>
                            <th>Asesor</th>
                            <th>Acción</th>
                            <th>Intento</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </form>
    </section>

    <!-- Modal Detalles de Cuentas -->
    <div id="bk" class="backdrop">
        <div class="modal">
            <div class="modal-hd">
                <h3 style="margin:0">Detalles de cuentas de alerta</h3>
                <button class="btn ghost" type="button" id="closeBk">✕</button>
            </div>
            <div style="padding:6px 6px 14px">
                <table id="tblCuentas">
                    <thead>
                        <tr>
                            <th>N° cuenta / préstamo</th>
                            <th>Entidad</th>
                            <th>Estado</th>
                            <th style="width:1%"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="row" style="margin-top:10px; justify-content:space-between">
                    <button class="btn secondary" type="button" id="addFila">Agregar fila</button>
                    <div class="row">
                        <button class="btn ghost" type="button" id="cancelCtas">Cancelar</button>
                        <button class="btn" type="button" id="saveCtas">Guardar detalle</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Datos de gestión -->
    <div id="bkGestion" class="backdrop">
        <div class="modal">
            <div class="modal-hd">
                <h3 style="margin:0">Datos de gestión</h3>
                <button class="btn ghost" type="button" id="closeGestion">✕</button>
            </div>
            <div style="padding:6px 6px 14px">
                <table style="width:100%">
                    <tbody>
                        <tr>
                            <td style="width:45%"><label>ID LLAMADA</label></td>
                            <td><input id="mg_idllamada" class="readonly readonly-strong" readonly></td>
                        </tr>
                        <tr>
                            <td><label>ID USER</label></td>
                            <td><input id="mg_iduser" class="readonly readonly-strong" readonly></td>
                        </tr>
                        <tr>
                            <td><label>DNI</label></td>
                            <td><input id="mg_dni" placeholder="Documento del cliente"></td>
                        </tr>
                        <tr>
                            <td><label>IDENTITY</label></td>
                            <td><input id="mg_identity" placeholder="Escribe el identity si aplica"></td>
                        </tr>
                        <tr>
                            <td><label>FECHA ENVÍO</label></td>
                            <td><input id="mg_fechaenvio" type="datetime-local"></td>
                        </tr>
                        <tr>
                            <td><label>ESTADO DE ALERTA</label></td>
                            <td>
                                <select id="mg_estadoalerta">
                                    <option value="">Cargando…</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td><label>MONTO</label></td>
                            <td><input id="mg_monto" placeholder="Ej. 120.50"></td>
                        </tr>
                    </tbody>
                </table>

                <!-- Lista -->
                <div style="margin-top:12px">
                    <strong>Gestiones agregadas</strong>
                    <table class="tabla-gestiones">
                        <thead>
                            <tr>
                                <th>ID llamada</th>
                                <th>ID user</th>
                                <th>DNI</th>
                                <th>Identity</th>
                                <th>Fecha envío</th>
                                <th>Estado de alerta</th>
                                <th>Monto</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tblGestionBody"></tbody>
                    </table>
                </div>

                <div class="row" style="margin-top:12px; justify-content:flex-end; gap:10px">
                    <button class="btn secondary" type="button" id="btnAddGestion"
                            style="margin-right:auto">
                        Agregar
                    </button>
                    <button class="btn ghost" type="button" id="cancelGestion">Cancelar</button>
                    <button class="btn" type="button" id="saveGestion">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ocultos -->
    <input type="hidden" id="identity_summary" />
    <input type="hidden" id="identity_json" />
    <input type="hidden" id="gestion_json" />
    <input type="hidden" id="monto_hidden" />

    <script>
        (() => {
            // ================== CONFIG ==================
            const API_BASE = "http://localhost:5000/api";

            // ================== HELPERS ==================
            const pad = (n) => String(n).padStart(2, '0');
            const toLocalInputDateTime = (d = new Date()) =>
                `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

            function getParam(k) {
                const sp = new URLSearchParams(location.search);
                const v = sp.get(k) || sp.get('@' + k) || sp.get(k.toUpperCase()) || sp.get(k.toLowerCase());
                return v ? decodeURIComponent(String(v).replace(/\+/g, ' ')) : '';
            }

            // ================== ESTADO GLOBAL UI ==================
            const PENDING_ALERTS = []; // cola de alertas por enviar
            let frm, statusPill, attemptsTableBody; // refs a DOM (se asignan en init)

            // ================== API WRAPPERS ==================
            async function fetchJson(url, opts) {
                const res = await fetch(url, opts);
                if (!res.ok) throw new Error(`HTTP ${res.status} - ${url}`);
                return res.json().catch(() => ({}));
            }

            async function obtenerAccionLlamada(tipo = 'SALIENTE') {
                const sel = document.getElementById('accion_llamada');
                if (!sel) return;
                try {
                    const lista = await fetchJson(`${API_BASE}/OBTENER_ACCION_LLAMADA?tipo=${encodeURIComponent(tipo)}`);
                    sel.innerHTML = '<option value="">Seleccione acción</option>';
                    (lista || []).forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.ID_FRAU_ACCION_LLAMADA;
                        opt.textContent = a.NOMBRE;
                        sel.appendChild(opt);
                    });
                } catch (e) {
                    console.warn('Error cargando acciones:', e);
                    sel.innerHTML = '<option value="">No disponible</option>';
                }
            }

            async function obtenerEstadosLlamada() {
                const sel = document.getElementById('estado_llamada_main');
                if (!sel) return;
                try {
                    const lista = await fetchJson(`${API_BASE}/Llamada/Estados`);
                    sel.innerHTML = '<option value="">Seleccione estado…</option>';
                    (lista || []).forEach(e => {
                        const opt = document.createElement('option');
                        opt.value = e.id;
                        opt.textContent = e.nombre;
                        sel.appendChild(opt);
                    });
                    if (sel.options.length > 1) {
                        sel.selectedIndex = 1;
                        sel.dispatchEvent(new Event('change'));
                    }
                } catch (err) {
                    console.warn('Error al obtener estados de llamada:', err);
                    sel.innerHTML = '<option value="">No disponible</option>';
                }
            }

            async function obtenerSubAcciones(idAccion) {
                if (!idAccion) return;
                const sel = document.getElementById('sub_accion_llamada');
                if (!sel) return;
                try {
                    const lista = await fetchJson(`${API_BASE}/OBTENER_SUB_ACCIONES_LLAMADA?id=${encodeURIComponent(idAccion)}`);
                    sel.innerHTML = '<option value="">Seleccione sub acción</option>';
                    (lista || []).forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.ID_FRAU_SUB_ACCION_LLAMADA;
                        opt.textContent = s.NOMBRE;
                        sel.appendChild(opt);
                    });
                    document.getElementById('detalle_validacion').innerHTML = '<option value="">Seleccione detalle / tipo validación</option>';
                } catch (e) {
                    console.warn('Error cargando subacciones:', e);
                }
            }

            async function obtenerDetalleSubAcciones(idSubAccion) {
                if (!idSubAccion) return;
                const sel = document.getElementById('detalle_validacion');
                if (!sel) return;
                try {
                    const lista = await fetchJson(`${API_BASE}/OBTENER_DETALLE_SUB_ACCIONES_LLAMADA?id=${encodeURIComponent(idSubAccion)}`);
                    sel.innerHTML = '<option value="">Seleccione detalle / tipo validación</option>';
                    (lista || []).forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.ID_FRAU_DETALLE_SUB_ACCION_LLAMADA;
                        opt.textContent = d.NOMBRE;
                        sel.appendChild(opt);
                    });
                } catch (e) {
                    console.warn('Error cargando detalles:', e);
                }
            }

            async function crearLlamadaOut(bodyInput = {}) {
                const payload = {
                    id_llamada: (bodyInput.id_llamada ?? document.getElementById('idllamada')?.value ?? '').trim(),
                    telefono_llamada: (bodyInput.telefono_llamada ?? document.getElementById('numero_in')?.value ?? '').trim(),
                    agente: (bodyInput.agente ?? document.getElementById('iduser')?.value ?? '').trim(),
                    cola: (bodyInput.cola ?? document.getElementById('grupo_cola')?.value ?? '').trim(),
                    fecha_inicio: (bodyInput.fecha_inicio ?? document.getElementById('fecha_in')?.value ?? '').replace(' ', 'T')
                };

                try {
                    const json = await fetchJson(`${API_BASE}/Llamada/CrearLlamadaSaliente`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    // guardar codigo_llamada si la API lo devuelve
                    if (json && json.codigo_llamada) {
                        window.COD_LLAMADA_OUT = json.codigo_llamada;
                        const id = document.getElementById('idllamada'); if (id) id.value = json.codigo_llamada;
                    } else {
                        window.COD_LLAMADA_OUT = payload.id_llamada;
                    }
                    if (statusPill) {
                        statusPill.className = 'pill ok';
                        statusPill.innerHTML = '<strong>Estado:</strong> Llamada creada';
                    }
                    return json;
                } catch (err) {
                    console.warn('CrearLlamadaSaliente error:', err);
                    if (statusPill) {
                        statusPill.className = 'pill warn';
                        statusPill.innerHTML = '<strong>Estado:</strong> Error al crear llamada';
                    }
                    return null;
                }
            }

            async function terminarLlamadaOut(payload) {
                const body = {
                    codigo_llamada: payload.COD_LLAMADA_OUT,
                    fecha_fin: new Date(payload.FECHA_FIN || new Date()).toISOString(),
                    nombre_cliente: payload.NOMBRE_CLIENTE || null,
                    telefono_cliente: payload.TELEFONO2 || null,
                    correo_cliente: payload.CORREO || null,
                    fecha_nacimiento_cliente: payload.FECHA_NACIMIENTO || null,
                    direccion_cliente: payload.DIRECCION || null,
                    observaciones: payload.OBSERVACIONES || null,
                    id_detalle_llamada: payload.ID_FRAU_DETALLE_SUB_ACCION_LLAMADA ?? null,
                    id_estado_llamada: payload.ID_FRAU_TIPO_VALIDACION ?? null,
                    numero_intentos: payload.NRO_INTENTO ?? 0
                };
                return fetchJson(`${API_BASE}/Llamada/ActualizarLlamadaSaliente`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                }).catch(e => { console.warn('ActualizarLlamadaSaliente error:', e); return null; });
            }

            async function crearAlerta(body) {
                return fetchJson(`${API_BASE}/Alerta/CrearAlerta`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                });
            }

            async function obtenerEstadosAlerta() {
                const sel = document.getElementById('mg_estadoalerta');
                if (!sel) return;
                try {
                    sel.innerHTML = '<option value="">Cargando…</option>';
                    const lista = await fetchJson(`${API_BASE}/EstadosAlerta`);
                    sel.innerHTML = '<option value="">Seleccione estado de alerta…</option>';
                    (lista || []).forEach(e => {
                        const opt = document.createElement('option');
                        opt.value = String(e.id);
                        opt.textContent = e.nombre;
                        sel.appendChild(opt);
                    });
                    if (sel.options.length > 1) {
                        sel.selectedIndex = 1;
                        sel.dispatchEvent(new Event('change'));
                    }
                } catch (err) {
                    console.warn('[EstadosAlerta] error:', err);
                    sel.innerHTML = '<option value="">No disponible</option>';
                }
            }

            // ================== MODAL GESTIÓN ==================
            const bkGestion = () => document.getElementById('bkGestion');
            const openGestion = () => bkGestion()?.classList.add('show');
            const closeGestion = () => bkGestion()?.classList.remove('show');

            function prefillGestion() {
                const get = id => document.getElementById(id);
                if (get('mg_idllamada')) get('mg_idllamada').value = get('idllamada')?.value || '';
                if (get('mg_iduser')) get('mg_iduser').value = get('iduser')?.value || '';
                if (get('mg_dni')) get('mg_dni').value = get('dni')?.value || '';
                if (get('mg_identity')) get('mg_identity').value = '';
                if (get('mg_fechaenvio')) get('mg_fechaenvio').value = toLocalInputDateTime(new Date());
                obtenerEstadosAlerta();
            }

            function buildAlertaFromModal() {
                const two = n => String(n).padStart(2, '0');
                const hhmmss = d => `${two(d.getHours())}:${two(d.getMinutes())}:${two(d.getSeconds())}`;

                const idLlamada = (document.getElementById('mg_idllamada')?.value || '').trim();
                const idUser = (document.getElementById('mg_iduser')?.value || '').trim();
                const dni = (document.getElementById('mg_dni')?.value || '').replace(/[^\d]/g, '');
                const identity = (document.getElementById('mg_identity')?.value || '').trim();
                const fechaIn = document.getElementById('mg_fechaenvio')?.value;
                const selEstado = document.getElementById('mg_estadoalerta');
                const idEstado = selEstado ? Number(selEstado.value) : null;
                const txtEstado = selEstado?.options[selEstado.selectedIndex]?.textContent || '';
                const montoStr = (document.getElementById('mg_monto')?.value || '').trim();
                const monto = montoStr ? Number(montoStr.replace(',', '.')) : null;

                const d = fechaIn ? new Date(String(fechaIn).replace(' ', 'T')) : new Date();
                const iso = d.toISOString();

                return {
                    codigo_llamada: idLlamada,
                    identidad: identity,
                    fecha_envio: iso,
                    hora_envio: hhmmss(d),
                    fecha_transaccion: iso,
                    hora_transaccion: hhmmss(d),
                    nro_documento: dni,
                    nro_cuenta: "",
                    nro_tarjeta: "",
                    tipo_transaccion: "",
                    importe_transaccion: monto,
                    nro_giro: "",
                    cuenta_destino: "",
                    documento_beneficiario: "",
                    nombre_beneficiario: "",
                    codigo_servicio_celular: "",
                    indicador_alerta: "",
                    canal: "WEB",
                    id_estado_alerta: idEstado,

                    _id_user: idUser,
                    _estado_text: txtEstado,
                    _status: 'Pendiente'
                };
            }

            function renderGestiones() {
                // usa tu tabla específica si existe: #gestionesTable, si no cae a #attemptsTable
                const tbd = document.querySelector('#gestionesTable tbody') || document.querySelector('#attemptsTable tbody');
                if (!tbd) return;
                tbd.innerHTML = '';
                for (const g of PENDING_ALERTS) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
            <td>${g.codigo_llamada}</td>
            <td>${g._id_user || '—'}</td>
            <td>${g.nro_documento || '—'}</td>
            <td>${g.identidad || '—'}</td>
            <td>${new Date(g.fecha_envio).toLocaleString()}</td>
            <td>${g._estado_text || g.id_estado_alerta || ''}</td>
            <td>${g.importe_transaccion ?? ''}</td>
            <td>${g._status || 'Pendiente'}</td>`;
                    tbd.appendChild(tr);
                }
            }

            async function enviarAlertasPendientes() {
                if (!PENDING_ALERTS.length) return { ok: true, total: 0, okCount: 0 };
                const results = await Promise.allSettled(PENDING_ALERTS.map(a => crearAlerta(a)));
                let okCount = 0;
                results.forEach((r, i) => {
                    if (r.status === 'fulfilled') {
                        okCount++;
                        PENDING_ALERTS[i]._status = 'OK';
                        PENDING_ALERTS[i]._codigo_alerta = r.value?.codigo_alerta || '';
                    } else {
                        PENDING_ALERTS[i]._status = 'ERROR';
                    }
                });
                renderGestiones();
                return { ok: okCount === PENDING_ALERTS.length, total: PENDING_ALERTS.length, okCount };
            }

            // ================== PREFILL POR URL + CREAR ==================
            async function prefillFromURLAndCreate() {
                // lee parámetros con tolerancia a mayúsculas y @
                const NOMBRE_AGENTE = getParam('NOMBRE_AGENTE') || getParam('agente');
                const NUMERO_IN = getParam('NUMERO_IN') || getParam('telefono_llamada');
                const DNI = getParam('DNI');
                const NOMBRE_GRUPO_COLA = getParam('NOMBRE_GRUPO_COLA') || getParam('cola');
                const FECHA_INI = getParam('FECHA_INI') || getParam('fecha_inicio');

                if (NOMBRE_AGENTE) document.getElementById('iduser')?.setAttribute('value', NOMBRE_AGENTE), (document.getElementById('iduser').value = NOMBRE_AGENTE);
                if (NUMERO_IN) document.getElementById('numero_in')?.setAttribute('value', NUMERO_IN), (document.getElementById('numero_in').value = NUMERO_IN);
                if (DNI) document.getElementById('dni')?.setAttribute('value', DNI), (document.getElementById('dni').value = DNI);
                if (NOMBRE_GRUPO_COLA) document.getElementById('grupo_cola')?.setAttribute('value', NOMBRE_GRUPO_COLA), (document.getElementById('grupo_cola').value = NOMBRE_GRUPO_COLA);
                if (FECHA_INI) {
                    const safe = FECHA_INI.includes(' ') ? FECHA_INI.replace(' ', 'T') : FECHA_INI;
                    document.getElementById('fecha_in')?.setAttribute('value', safe);
                    document.getElementById('fecha_in').value = safe;
                }

                // crear llamada si hay datos base
                const id = document.getElementById('idllamada')?.value || crypto.randomUUID();
                if (document.getElementById('idllamada')) document.getElementById('idllamada').value = id;

                if ((NUMERO_IN || document.getElementById('numero_in')?.value) &&
                    (NOMBRE_AGENTE || document.getElementById('iduser')?.value) &&
                    (NOMBRE_GRUPO_COLA || document.getElementById('grupo_cola')?.value) &&
                    (FECHA_INI || document.getElementById('fecha_in')?.value)) {
                    await crearLlamadaOut({
                        id_llamada: id,
                        telefono_llamada: NUMERO_IN || document.getElementById('numero_in')?.value,
                        agente: NOMBRE_AGENTE || document.getElementById('iduser')?.value,
                        cola: NOMBRE_GRUPO_COLA || document.getElementById('grupo_cola')?.value,
                        fecha_inicio: FECHA_INI || document.getElementById('fecha_in')?.value
                    });
                }
            }

            // ================== INIT & LISTENERS ==================
            document.addEventListener('DOMContentLoaded', () => {
                // cache refs
                frm = document.getElementById('frm');
                statusPill = document.getElementById('statusPill');
                attemptsTableBody = document.querySelector('#attemptsTable tbody');

                // valores iniciales mínimos
                const idllamada = document.getElementById('idllamada');
                if (idllamada && !idllamada.value) idllamada.value = crypto.randomUUID();
                const iduser = document.getElementById('iduser');
                if (iduser && !iduser.value) iduser.value = 'asesor-demo-001';
                const fin = document.getElementById('fecha_in');
                if (fin && !fin.value) fin.value = toLocalInputDateTime(new Date());

                // catálogos
                obtenerAccionLlamada('SALIENTE');
                obtenerEstadosLlamada();

                // encadenados
                document.getElementById('accion_llamada')?.addEventListener('change', e => obtenerSubAcciones(e.target.value));
                document.getElementById('sub_accion_llamada')?.addEventListener('change', e => obtenerDetalleSubAcciones(e.target.value));

                // modal: abrir
                document.getElementById('btnGestion')?.addEventListener('click', () => {
                    prefillGestion();
                    openGestion();
                });

                // modal: botones propios del usuario
                document.getElementById('btnAddGestion')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    const a = buildAlertaFromModal();
                    if (!a.codigo_llamada) return alert('Falta ID LLAMADA');
                    if (!a.nro_documento) return alert('Falta DNI');
                    if (!a.id_estado_alerta) return alert('Seleccione ESTADO DE ALERTA');
                    PENDING_ALERTS.push(a);
                    renderGestiones();
                    closeGestion(); // opcional
                });

                document.getElementById('cancelGestion')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    closeGestion();
                });

                document.getElementById('saveGestion')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    // aquí no enviamos; solo cerramos (el envío real es al guardar el form principal)
                    closeGestion();
                });

                // submit del formulario principal
                frm?.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const selIntento = document.getElementById('intento_alerta');
                    if (!document.getElementById('dni')?.value.trim()) return alert('Ingrese DNI.');
                    if (!selIntento?.value) return alert('Seleccione INTENTO ALERTA (1, 2 o 3).');

                    const fechaFin = new Date();
                    const fechaFinInput = document.getElementById('fecha_fin');
                    if (fechaFinInput) fechaFinInput.value = toLocalInputDateTime(fechaFin);

                    const COD_LLAMADA_OUT = (window.COD_LLAMADA_OUT && String(window.COD_LLAMADA_OUT)) || document.getElementById('idllamada')?.value.trim();
                    await terminarLlamadaOut({
                        COD_LLAMADA_OUT,
                        FECHA_FIN: new Date(),
                        NOMBRE_CLIENTE: document.getElementById('nombre_cliente')?.value.trim(),
                        TELEFONO2: document.getElementById('telefono2')?.value.trim(),
                        CORREO: document.getElementById('correo')?.value.trim(),
                        DNI_2: document.getElementById('dni')?.value.trim(),
                        FECHA_NACIMIENTO: document.getElementById('fecha_nacimiento')?.value || null,
                        DIRECCION: document.getElementById('direccion')?.value.trim(),
                        OBSERVACIONES: document.getElementById('observaciones')?.value.trim(),
                        TIENE_ALERTA: (() => {
                            try { return (JSON.parse(document.getElementById('identity_json')?.value || '[]').length ? 1 : 0); }
                            catch { return 0; }
                        })(),
                        ID_FRAU_TIPO_VALIDACION: document.getElementById('detalle_validacion')?.value || null,
                        ID_FRAU_DETALLE_SUB_ACCION_LLAMADA: document.getElementById('sub_accion_llamada')?.value || null,
                        ID_FRAU_ALERTA: null,
                        NRO_INTENTO: Number(selIntento?.value || 1)
                    });

                    // envía las alertas agregadas
                    const r = await enviarAlertasPendientes();
                    if (r.total) alert(`Alertas enviadas: ${r.okCount}/${r.total}`);
                    if (r.ok) { PENDING_ALERTS.length = 0; renderGestiones(); }

                    alert('Registro guardado.');
                });

                // por último: prefill por URL + crear llamada
                prefillFromURLAndCreate();
            });
        })();
    </script>




</body>

</html>