<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Interfaz OUT – Registro de Llamadas</title>
    <style>
        :root {
            --bg: #f7f9fc;
            --card: #ffffff;
            --ink: #1f2937;
            --muted: #6b7280;
            --primary: #2563eb;
            --border: #e5e7eb;
            --ok: #16a34a;
            --warn: #eab308;
            --ro-bkg: #eef2ff;
            --ro-ink: #1e3a8a;
            --ro-bd: #c7d2fe;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif
        }

        header {
            max-width: 1100px;
            margin: 28px auto 0;
            padding: 0 18px 8px
        }

        h1 {
            font-size: 28px;
            margin: 0 0 6px
        }

        .card {
            max-width: 1100px;
            margin: 14px auto 22px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 22px 20px;
            box-shadow: 0 6px 20px rgba(31, 41, 55, .06)
        }

        form {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(2, minmax(0, 1fr))
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        label {
            font-size: 20px;
            font-weight: 600
        }

        input,
        select,
        textarea {
            font-size: 18px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #fff;
            outline: none;
            transition: border-color .15s, box-shadow .15s
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, .12)
        }

        .full {
            grid-column: 1/-1
        }

        .readonly {
            background: #f3f4f6
        }

        .readonly-strong {
            background: var(--ro-bkg) !important;
            color: var(--ro-ink) !important;
            border-color: var(--ro-bd) !important;
            font-weight: 700
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap
        }

        .btn {
            font-size: 16px;
            font-weight: 600;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid transparent;
            background: var(--primary);
            color: #fff;
            cursor: pointer
        }

        .btn.primary,
        .btn.secondary {
            background: #fff;
            color: var(--ink);
            border-color: var(--border)
        }

        .btn.ghost {
            background: transparent;
            color: var(--primary);
            border-color: transparent
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--border);
            background: #fff
        }

        .pill.ok {
            border-color: #bbf7d0;
            background: #ecfdf5;
            color: var(--ok)
        }

        .pill.warn {
            border-color: #fef08a;
            background: #fffbeb;
            color: #854d0e
        }

        .attempts {
            border-top: 1px dashed var(--border);
            padding-top: 14px;
            margin-top: 8px
        }

        .attempts table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px
        }

        .attempts th,
        .attempts td {
            border-bottom: 1px solid var(--border);
            padding: 8px 6px;
            text-align: left
        }

        .foot {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 12px
        }

        @media (max-width:900px) {
            form {
                grid-template-columns: 1fr
            }
        }

        /* Modal */
        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .35);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 50
        }

        .backdrop.show {
            display: flex
        }

        .modal {
            width: min(920px, 100%);
            background: #fff;
            border-radius: 14px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, .2);
            padding: 14px
        }

        .modal-hd {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 6px 12px
        }

        .modal table {
            width: 100%;
            border-collapse: collapse
        }

        .modal th,
        .modal td {
            border-bottom: 1px solid var(--border);
            padding: 8px
        }

        .modal input,
        .modal select {
            width: 100%
        }

        .muted {
            color: var(--muted)
        }

        .tabla-gestiones th,
        .tabla-gestiones td {
            text-align: center;
            vertical-align: middle
        }

        .tabla-gestiones td:nth-child(1),
        .tabla-gestiones td:nth-child(2),
        .tabla-gestiones td:nth-child(3) {
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace
        }
    </style>
</head>

<body>
    <header>
        <h1>Registro de datos para llamadas salientes</h1>
    </header>

    <section class="card">
        <div class="row" style="justify-content:space-between; margin-bottom:8px">
            <div class="pill" id="statusPill"><strong>Estado:</strong> Listo</div>
            <div class="row">
                <button class="btn secondary" type="button" id="btnIntentos">Ver intentos (24 h)</button>
                <button class="btn ghost" type="button" id="btnLimpiar">Limpiar</button>
            </div>
        </div>

        <form id="frm">
            <div class="field">
                <label for="idllamada">ID LLAMADA</label>
                <input id="idllamada" name="idllamada" maxlength="50" placeholder="ID de Genesys (URL)" class="readonly"
                    readonly />
            </div>

            <div class="field">
                <label for="iduser">ID USER</label>
                <input id="iduser" name="iduser" maxlength="50" placeholder="ID del asesor (Genesys URL)"
                    class="readonly" readonly />
            </div>

            <div class="field">
                <label for="numero_in">CELULAR CLIENTE</label>
                <input id="numero_in" name="numero_in" maxlength="20" inputmode="tel" placeholder="Ej. 999888777" />
            </div>

            <div class="field">
                <label for="dni">DNI</label>
                <div class="row">
                    <input id="dni" name="dni" maxlength="15" placeholder="Documento del cliente" style="flex:1" />
                    <button class="btn secondary" type="button" id="btnBuscarDni">Buscar cliente</button>
                </div>
            </div>

            <div class="field">
                <label for="grupo_cola">GRUPO COLA</label>
                <input id="grupo_cola" name="grupo_cola" maxlength="50" placeholder="Cola ACD (Genesys)" />
            </div>

            <div class="field">
                <label for="fecha_in">INICIO DE LLAMADA</label>
                <input id="fecha_in" name="fecha_in" type="datetime-local" />
            </div>

            <div class="field">
                <label for="nombre_cliente">NOMBRE CLIENTE</label>
                <input id="nombre_cliente" name="nombre_cliente" maxlength="50" placeholder="Nombre del cliente" />
            </div>

            <div class="field">
                <label for="telefono2">TELEFONO 2</label>
                <input id="telefono2" name="telefono2" maxlength="20" inputmode="tel" placeholder="Teléfono alterno" />
            </div>

            <div class="field">
                <label for="correo">CORREO</label>
                <input id="correo" name="correo" maxlength="50" type="email" placeholder="correo@dominio.com" />
            </div>

            <div class="field">
                <label for="fecha_nacimiento">FECHA NACIMIENTO</label>
                <input id="fecha_nacimiento" name="fecha_nacimiento" type="date" />
            </div>

            <div class="field full">
                <label for="direccion">DIRECCION</label>
                <input id="direccion" name="direccion" maxlength="300" placeholder="Dirección completa" />
            </div>

            <div class="field full">
                <label for="observaciones">OBSERVACIONES</label>
                <textarea id="observaciones" name="observaciones" maxlength="1000" rows="4"
                    placeholder="Notas del agente"></textarea>
            </div>

            <div class="field">
                <label for="intento_alerta">INTENTO ALERTA</label>
                <select id="intento_alerta" name="intento_alerta">
                    <option value="">Seleccione…</option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                </select>
            </div>

            <div class="field">
                <label>DATOS DE ALERTA</label>
                <div class="row" style="width:100%">
                    <button class="btn primary" type="button" id="btnGestion">Datos de gestión</button>
                    <button class="btn secondary" type="button" id="btnCuentas">Detalles de cuentas</button>
                </div>
                <span class="hint">Resumen cuentas: <span id="resumenCuentas" class="muted">—</span></span>
            </div>

            <div class="field">
                <label for="accion_llamada">ACCIÓN LLAMADA</label>
                <select id="accion_llamada" name="accion_llamada">
                    <option value="">Seleccione acción…</option>
                </select>
            </div>

            <div class="field">
                <label for="sub_accion_llamada">SUB ACCIÓN LLAMADA</label>
                <select id="sub_accion_llamada" name="sub_accion_llamada">
                    <option value="">Seleccione sub acción…</option>
                </select>
            </div>

            <div class="field">
                <label for="estado_llamada_main">ESTADO LLAMADA</label>
                <select id="estado_llamada_main" name="estado_llamada_main">
                    <option value="">Seleccione…</option>
                    <option value="concluido">Concluido</option>
                    <option value="no_concluido">No concluido</option>
                </select>
            </div>

            <div class="field">
                <label for="detalle_validacion">DETALLE / TIPO VALIDACIÓN</label>
                <select id="detalle_validacion" name="detalle_validacion">
                    <option value="">Seleccione detalle / tipo validación…</option>
                </select>
            </div>

            <div class="field">
                <label>TIPIFICACIÓN</label>
                <div class="row">
                    <label class="pill"><input type="radio" name="tipificacion" value="1"> &nbsp;1</label>
                    <label class="pill"><input type="radio" name="tipificacion" value="2"> &nbsp;2</label>
                </div>
            </div>

            <input type="hidden" id="fecha_fin" name="fecha_fin" />

            <div class="full foot">
                <button class="btn" type="submit">Guardar</button>
            </div>

            <div class="full attempts" id="attemptsPanel" hidden>
                <div class="row" style="justify-content:space-between; margin-bottom:10px">
                    <strong>Intentos en las últimas 24 horas:</strong>
                    <span id="attemptsBadge" class="pill">0 intentos</span>
                </div>
                <div id="attemptsWarn" class="pill warn" style="margin-bottom:10px" hidden>Se encontraron intentos
                    previos.</div>
                <table id="attemptsTable">
                    <thead>
                        <tr>
                            <th>Fecha/Hora</th>
                            <th>ID</th>
                            <th>Asesor</th>
                            <th>Acción</th>
                            <th>Intento</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </form>
    </section>

    <!-- Modal Detalles de Cuentas -->
    <div id="bk" class="backdrop">
        <div class="modal">
            <div class="modal-hd">
                <h3 style="margin:0">Detalles de cuentas de alerta</h3>
                <button class="btn ghost" type="button" id="closeBk">✕</button>
            </div>
            <div style="padding:6px 6px 14px">
                <table id="tblCuentas">
                    <thead>
                        <tr>
                            <th>N° cuenta / préstamo</th>
                            <th>Entidad</th>
                            <th>Estado</th>
                            <th style="width:1%"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="row" style="margin-top:10px; justify-content:space-between">
                    <button class="btn secondary" type="button" id="addFila">Agregar fila</button>
                    <div class="row">
                        <button class="btn ghost" type="button" id="cancelCtas">Cancelar</button>
                        <button class="btn" type="button" id="saveCtas">Guardar detalle</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Datos de gestión -->
    <div id="bkGestion" class="backdrop">
        <div class="modal">
            <div class="modal-hd">
                <h3 style="margin:0">Datos de gestión</h3>
                <button class="btn ghost" type="button" id="closeGestion">✕</button>
            </div>
            <div style="padding:6px 6px 14px">
                <table style="width:100%">
                    <tbody>
                        <tr>
                            <td style="width:45%"><label>ID LLAMADA</label></td>
                            <td><input id="mg_idllamada" class="readonly readonly-strong" readonly></td>
                        </tr>
                        <tr>
                            <td><label>ID USER</label></td>
                            <td><input id="mg_iduser" class="readonly readonly-strong" readonly></td>
                        </tr>
                        <tr>
                            <td><label>DNI</label></td>
                            <td><input id="mg_dni" placeholder="Documento del cliente"></td>
                        </tr>
                        <tr>
                            <td><label>IDENTITY</label></td>
                            <td><input id="mg_identity" placeholder="Escribe el identity si aplica"></td>
                        </tr>
                        <tr>
                            <td><label>FECHA ENVÍO</label></td>
                            <td><input id="mg_fechaenvio" type="datetime-local"></td>
                        </tr>
                        <tr>
                            <td><label>ESTADO DE ALERTA</label></td>
                            <td>
                                <select id="mg_estadoalerta">
                                    <option value="">Cargando…</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td><label>MONTO</label></td>
                            <td><input id="mg_monto" placeholder="Ej. 120.50"></td>
                        </tr>
                    </tbody>
                </table>

                <!-- Lista -->
                <div style="margin-top:12px">
                    <strong>Gestiones agregadas</strong>
                    <table class="tabla-gestiones">
                        <thead>
                            <tr>
                                <th>ID llamada</th>
                                <th>ID user</th>
                                <th>DNI</th>
                                <th>Identity</th>
                                <th>Fecha envío</th>
                                <th>Estado de alerta</th>
                                <th>Monto</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tblGestionBody"></tbody>
                    </table>
                </div>

                <div class="row" style="margin-top:12px; justify-content:flex-end; gap:10px">
                    <button class="btn secondary" type="button" id="btnAddGestion"
                        style="margin-right:auto">Agregar</button>
                    <button class="btn ghost" type="button" id="cancelGestion">Cancelar</button>
                    <button class="btn" type="button" id="saveGestion">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ocultos -->
    <input type="hidden" id="identity_summary" />
    <input type="hidden" id="identity_json" />
    <input type="hidden" id="gestion_json" />
    <input type="hidden" id="monto_hidden" />

    <script>
        // ==== CONFIGURACIÓN GENERAL ====
        const API_BASE = 'http://10.6.20.49/api';
        const pad = (n) => String(n).padStart(2, '0');
        const toLocalInputDateTime = (d = new Date()) =>
            `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        const withinLastHours = (iso, h = 24) => Date.now() - new Date(iso).getTime() <= h * 3600 * 1000;
        const qs = (k) => {
            const p = new URLSearchParams(window.location.search);
            const v = p.get(k) || p.get('@' + k);
            return v ? decodeURIComponent(v.replace(/\+/g, ' ')) : '';
        };
        function toSQLDateTime(input) {
            if (!input) return null;
            const d = (input instanceof Date) ? input : new Date(String(input).replace(' ', 'T'));
            if (isNaN(d.getTime())) return null;
            const ms = String(d.getMilliseconds()).padStart(3, '0');
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}.${ms}`;
        }
        function toInputLocalFromSQL(dtStr) {
            if (!dtStr) return '';
            const safe = dtStr.trim().replace(' ', 'T');
            const d = new Date(safe);
            if (Number.isNaN(d.getTime())) return '';
            return toLocalInputDateTime(d);
        }

        // ==== CARGAS INICIALES ====
        async function obtenerAccionLlamada(tipo = 'SALIENTE') {
            try {
                const res = await fetch(`${API_BASE}/OBTENER_ACCION_LLAMADA?tipo=${encodeURIComponent(tipo)}`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const lista = await res.json();
                const sel = document.getElementById('accion_llamada');
                sel.innerHTML = '<option value="">Seleccione acción</option>';
                lista.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a.ID_FRAU_ACCION_LLAMADA;
                    opt.textContent = a.NOMBRE;
                    sel.appendChild(opt);
                });
            } catch (e) {
                console.warn('Error cargando acciones:', e);
                alert('No se pudieron cargar las acciones de llamada.');
            }
        }

        async function obtenerEstadosLlamada() {
            try {
                const res = await fetch(`${API_BASE}/OBTENER_ESTADOS_LLAMADA`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const lista = await res.json();
                const sel = document.getElementById('estado_llamada_main');
                sel.innerHTML = '<option value="">Seleccione estado…</option>';
                lista.forEach(e => {
                    const opt = document.createElement('option');
                    opt.value = e.ID_FRAU_ESTADO_LLAMADA;
                    opt.textContent = e.NOMBRE;
                    sel.appendChild(opt);
                });
            } catch (err) {
                console.warn('Error al obtener estados de llamada:', err);
                alert('No se pudieron cargar los estados de llamada desde la API.');
            }
        }

        async function obtenerSubAcciones(idAccion) {
            if (!idAccion) return;
            try {
                const res = await fetch(`${API_BASE}/OBTENER_SUB_ACCIONES_LLAMADA?id=${encodeURIComponent(idAccion)}`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const lista = await res.json();
                const sel = document.getElementById('sub_accion_llamada');
                sel.innerHTML = '<option value="">Seleccione sub acción</option>';
                lista.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.ID_FRAU_SUB_ACCION_LLAMADA;
                    opt.textContent = s.NOMBRE;
                    sel.appendChild(opt);
                });
                document.getElementById('detalle_validacion').innerHTML = '<option value="">Seleccione detalle / tipo validación</option>';
            } catch (e) {
                console.warn('Error cargando subacciones:', e);
                alert('No se pudieron cargar las sub acciones.');
            }
        }

        async function obtenerDetalleSubAcciones(idSubAccion) {
            if (!idSubAccion) return;
            try {
                const res = await fetch(`${API_BASE}/OBTENER_DETALLE_SUB_ACCIONES_LLAMADA?id=${encodeURIComponent(idSubAccion)}`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const lista = await res.json();
                const sel = document.getElementById('detalle_validacion');
                sel.innerHTML = '<option value="">Seleccione detalle / tipo validación</option>';
                lista.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.ID_FRAU_DETALLE_SUB_ACCION_LLAMADA;
                    opt.textContent = d.NOMBRE;
                    sel.appendChild(opt);
                });
            } catch (e) {
                console.warn('Error cargando detalles:', e);
                alert('No se pudieron cargar los detalles.');
            }
        }

        // ==== CREAR_LLAMADA_OUT ====
        async function crearLlamadaOut(payload) {
            try {
                const ctrl = new AbortController();
                const timer = setTimeout(() => ctrl.abort(), 10000);
                const body = {
                    '@NOMBRE_AGENTE': payload.NOMBRE_AGENTE,
                    '@NUMERO_IN': payload.NUMERO_IN,
                    '@DNI': payload.DNI,
                    '@NOMBRE_GRUPO_COLA': payload.NOMBRE_GRUPO_COLA,
                    '@FECHA_INI': payload.FECHA_INI
                };
                const res = await fetch(`${API_BASE}/CREAR_LLAMADA_OUT`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    signal: ctrl.signal
                });
                clearTimeout(timer);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json().catch(() => ({}));
                statusPill.className = 'pill ok';
                statusPill.innerHTML = '<strong>Estado:</strong> Llamada creada';
                window.COD_LLAMADA_OUT = json.COD_LLAMADA_OUT || json.cod || '';
                return json;
            } catch (e) {
                console.warn('crearLlamadaOut error:', e);
                statusPill.className = 'pill warn';
                statusPill.innerHTML = '<strong>Estado:</strong> Error al crear llamada';
                alert('No se pudo crear la llamada en la API.');
                return null;
            }
        }

        // ==== OBTENER ESTADOS DE ALERTA (nuevo) ====
        async function obtenerEstadosAlerta() {
            const sel = document.getElementById('mg_estadoalerta');
            if (!sel) return;
            try {
                sel.innerHTML = '<option value="">Cargando…</option>';
                const res = await fetch(`${API_BASE}/OBTENER_ESTADOS_ALERTA`);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const lista = await res.json();
                sel.innerHTML = '<option value="">Seleccione estado de alerta…</option>';
                (lista || []).forEach(e => {
                    const opt = document.createElement('option');
                    opt.value = e.ID_FRAU_ESTADO_ALERTA;
                    opt.textContent = e.NOMBRE;
                    sel.appendChild(opt);
                });
            } catch (err) {
                console.warn('Error al obtener estados de alerta:', err);
                sel.innerHTML = '<option value="">No disponible</option>';
                alert('No se pudieron cargar los estados de alerta.');
            }
        }

        // ==== TERMINAR_LLAMADA_OUT ====
        async function terminarLlamadaOut(payload) {
            const body = {
                '@COD_LLAMADA_OUT': payload.COD_LLAMADA_OUT,
                '@FECHA_FIN': payload.FECHA_FIN ? toSQLDateTime(payload.FECHA_FIN) : null,
                '@NOMBRE_CLIENTE': payload.NOMBRE_CLIENTE || null,
                '@TELEFONO2': payload.TELEFONO2 || null,
                '@CORREO': payload.CORREO || null,
                '@DNI_2': payload.DNI_2 || null,
                '@FECHA_NACIMIENTO': payload.FECHA_NACIMIENTO || null,
                '@DIRECCION': payload.DIRECCION || null,
                '@OBSERVACIONES': payload.OBSERVACIONES || null,
                '@TIENE_ALERTA': payload.TIENE_ALERTA ?? null,
                '@ID_FRAU_TIPO_VALIDACION': payload.ID_FRAU_TIPO_VALIDACION ?? null,
                '@ID_FRAU_DETALLE_SUB_ACCION_LLAMADA': payload.ID_FRAU_DETALLE_SUB_ACCION_LLAMADA ?? null,
                '@ID_FRAU_ALERTA': payload.ID_FRAU_ALERTA ?? null,
                '@NRO_INTENTO': payload.NRO_INTENTO ?? null
            };

            try {
                const ctrl = new AbortController();
                const timer = setTimeout(() => ctrl.abort(), 15000);
                const res = await fetch(`${API_BASE}/TERMINAR_LLAMADA_OUT`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                    signal: ctrl.signal
                });
                clearTimeout(timer);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json().catch(() => ({}));
                console.log('TERMINAR_LLAMADA_OUT OK ->', json);
                return json;
            } catch (e) {
                console.warn('TERMINAR_LLAMADA_OUT error:', e);
                alert('No se pudo terminar la llamada en la API.');
                return null;
            }
        }

        // ==== MODAL GESTIÓN ====
        const bkGestion = document.getElementById('bkGestion');
        const openGestion = () => bkGestion.classList.add('show');
        const closeGestion = () => bkGestion.classList.remove('show');

        function prefillGestion() {
            document.getElementById('mg_idllamada').value = document.getElementById('idllamada').value || '';
            document.getElementById('mg_iduser').value = document.getElementById('iduser').value || '';
            document.getElementById('mg_dni').value = document.getElementById('dni').value || '';
            document.getElementById('mg_identity').value = '';
            document.getElementById('mg_fechaenvio').value = toLocalInputDateTime(new Date());
        }

        document.getElementById('btnGestion').addEventListener('click', () => {
            prefillGestion();
            obtenerEstadosAlerta();
            openGestion();
        });
        document.getElementById('closeGestion').addEventListener('click', closeGestion);
        document.getElementById('cancelGestion').addEventListener('click', closeGestion);

        // ==== LOCALSTORAGE ====
        const KEY = 'out_intentos_llamada_v1';
        const loadIntents = () => JSON.parse(localStorage.getItem(KEY) || '[]');
        const saveIntents = (a) => localStorage.setItem(KEY, JSON.stringify(a));

        const frm = document.getElementById('frm');
        const statusPill = document.getElementById('statusPill');
        const attemptsPanel = document.getElementById('attemptsPanel');
        const attemptsBadge = document.getElementById('attemptsBadge');
        const attemptsWarn = document.getElementById('attemptsWarn');
        const tbody = document.querySelector('#attemptsTable tbody');
        const selIntento = document.getElementById('intento_alerta');
        const resumenCuentas = document.getElementById('resumenCuentas');
        const identitySummary = document.getElementById('identity_summary');
        const identityJson = document.getElementById('identity_json');
        const gestionJson = document.getElementById('gestion_json');
        const montoHidden = document.getElementById('monto_hidden');

        // ==== INIT FORM ====
        function initForm() {
            document.getElementById('idllamada').value = crypto.randomUUID();
            document.getElementById('iduser').value = 'asesor-demo-001';
            document.getElementById('fecha_in').value = toLocalInputDateTime(new Date());
            document.getElementById('fecha_fin').value = '';
            identitySummary.value = ''; identityJson.value = '[]'; gestionJson.value = '[]'; montoHidden.value = '';
            resumenCuentas.textContent = '—';
            buscarIntentos();
            obtenerAccionLlamada('SALIENTE');
            obtenerEstadosLlamada();
        }

        // ==== PREFILL + CREAR LLAMADA ====
        async function prefillFromURLAndCreate() {
            const NOMBRE_AGENTE = qs('NOMBRE_AGENTE');
            const NUMERO_IN = qs('NUMERO_IN');
            const DNI = qs('DNI');
            const NOMBRE_GRUPO_COLA = qs('NOMBRE_GRUPO_COLA');
            const FECHA_INI = qs('FECHA_INI');
            const anyParam = [NOMBRE_AGENTE, NUMERO_IN, DNI, NOMBRE_GRUPO_COLA, FECHA_INI].some(Boolean);
            if (anyParam) {
                if (NOMBRE_AGENTE) { const iu = document.getElementById('iduser'); iu.value = NOMBRE_AGENTE; iu.classList.add('readonly'); }
                if (NUMERO_IN) document.getElementById('numero_in').value = NUMERO_IN;
                if (DNI) document.getElementById('dni').value = DNI;
                if (NOMBRE_GRUPO_COLA) document.getElementById('grupo_cola').value = NOMBRE_GRUPO_COLA;
                if (FECHA_INI) document.getElementById('fecha_in').value = toInputLocalFromSQL(FECHA_INI);
                if (DNI) buscarIntentos();
            }
            const readyForAPI = [NOMBRE_AGENTE, NUMERO_IN, DNI, NOMBRE_GRUPO_COLA, FECHA_INI].every(Boolean);
            if (!readyForAPI) return;
            const payload = { NOMBRE_AGENTE, NUMERO_IN, DNI, NOMBRE_GRUPO_COLA, FECHA_INI };
            await crearLlamadaOut(payload);
        }

        // ==== BUSCAR INTENTOS ====
        function buscarIntentos() {
            const dni = document.getElementById('dni').value.trim();
            const lista = loadIntents()
                .filter(x => x.dni === dni && withinLastHours(x.fecha_fin_iso, 24))
                .sort((a, b) => new Date(b.fecha_fin_iso) - new Date(a.fecha_fin_iso));

            tbody.innerHTML = '';
            for (const x of lista) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td>${new Date(x.fecha_fin_iso).toLocaleString()}</td>
                <td>${x.idllamada}</td>
                <td>${x.iduser}</td>
                <td>${x.accion_llamada || ''}</td>
                <td>${x.intento_alerta || ''}</td>`;
                tbody.appendChild(tr);
            }
            attemptsBadge.textContent = `${lista.length} intento${lista.length === 1 ? '' : 's'}`;
            attemptsWarn.hidden = lista.length === 0;
            attemptsPanel.hidden = false;
            statusPill.className = 'pill ' + (lista.length ? 'warn' : 'ok');
            statusPill.innerHTML = '<strong>Estado:</strong> ' + (lista.length ? 'Con intentos previos (24 h)' : 'Sin intentos previos');
        }

        // ==== GUARDAR Y TERMINAR LLAMADA ====
        frm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!document.getElementById('dni').value.trim()) { alert('Ingrese DNI.'); return; }
            if (!selIntento.value) { alert('Seleccione INTENTO ALERTA (1, 2 o 3).'); return; }

            const fechaFin = new Date();
            document.getElementById('fecha_fin').value = toLocalInputDateTime(fechaFin);
            const COD_LLAMADA_OUT =
                (window.COD_LLAMADA_OUT && String(window.COD_LLAMADA_OUT)) ||
                document.getElementById('idllamada').value.trim();

            const payloadTerminar = {
                COD_LLAMADA_OUT,
                FECHA_FIN: new Date(),
                NOMBRE_CLIENTE: document.getElementById('nombre_cliente').value.trim(),
                TELEFONO2: document.getElementById('telefono2').value.trim(),
                CORREO: document.getElementById('correo').value.trim(),
                DNI_2: document.getElementById('dni').value.trim(),
                FECHA_NACIMIENTO: document.getElementById('fecha_nacimiento').value || null,
                DIRECCION: document.getElementById('direccion').value.trim(),
                OBSERVACIONES: document.getElementById('observaciones').value.trim(),
                TIENE_ALERTA: (identityJson.value && JSON.parse(identityJson.value || '[]').length) ? 1 : 0,
                ID_FRAU_TIPO_VALIDACION: document.getElementById('detalle_validacion').value || null,
                ID_FRAU_DETALLE_SUB_ACCION_LLAMADA: document.getElementById('sub_accion_llamada').value || null,
                ID_FRAU_ALERTA: null,
                NRO_INTENTO: Number(selIntento.value || 1)
            };

            await terminarLlamadaOut(payloadTerminar);

            const registro = {
                idllamada: document.getElementById('idllamada').value.trim(),
                iduser: document.getElementById('iduser').value.trim(),
                numero_in: document.getElementById('numero_in').value.trim(),
                dni: document.getElementById('dni').value.trim(),
                grupo_cola: document.getElementById('grupo_cola').value.trim(),
                fecha_in_iso: new Date(document.getElementById('fecha_in').value).toISOString(),
                fecha_fin_iso: fechaFin.toISOString(),
                nombre_cliente: document.getElementById('nombre_cliente').value.trim(),
                telefono2: document.getElementById('telefono2').value.trim(),
                correo: document.getElementById('correo').value.trim(),
                fecha_nacimiento: document.getElementById('fecha_nacimiento').value,
                direccion: document.getElementById('direccion').value.trim(),
                observaciones: document.getElementById('observaciones').value.trim(),
                intento_alerta: selIntento.value,
                accion_llamada: document.getElementById('accion_llamada').value,
                sub_accion_llamada: document.getElementById('sub_accion_llamada').value,
                detalle_validacion: document.getElementById('detalle_validacion').value,
                identity: identitySummary.value,
                identity_json: identityJson.value,
                gestion_json: gestionJson.value,
                monto: montoHidden.value
            };

            const arr = loadIntents(); arr.push(registro); saveIntents(arr);
            alert('Registro guardado (intento de llamada registrado).');
            buscarIntentos();
            document.getElementById('idllamada').value = crypto.randomUUID();
        });

        // ==== EVENTOS DE CARGA EN CASCADA ====
        document.getElementById('accion_llamada').addEventListener('change', (e) => {
            obtenerSubAcciones(e.target.value);
        });
        document.getElementById('sub_accion_llamada').addEventListener('change', (e) => {
            obtenerDetalleSubAcciones(e.target.value);
        });

        // ==== INIT GENERAL ====
        initForm();
        prefillFromURLAndCreate();
    </script>


</body>

</html>